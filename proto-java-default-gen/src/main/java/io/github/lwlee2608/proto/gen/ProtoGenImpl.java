package io.github.lwlee2608.proto.gen;

import io.github.lwlee2608.proto.annotation.processor.ProtoFile;
import lombok.SneakyThrows;
import org.codehaus.plexus.util.cli.CommandLineUtils;
import org.codehaus.plexus.util.cli.Commandline;

import javax.annotation.processing.Filer;
import javax.tools.FileObject;
import javax.tools.JavaFileObject;
import javax.tools.StandardLocation;
import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.io.PrintWriter;
import java.nio.file.Paths;
import java.util.List;

public class ProtoGenImpl implements ProtoGen {
    private final CommandLineUtils.StringStreamConsumer error = new CommandLineUtils.StringStreamConsumer();
    private final CommandLineUtils.StringStreamConsumer output = new CommandLineUtils.StringStreamConsumer();

    @Override
    public void generate(Filer filer, List<ProtoFile> protoFiles) {
        protocGenerate(filer, protoFiles);
        //generateConverter(filer, protoFiles);
    }

    @SneakyThrows
    public void protocGenerate(Filer filer, List<ProtoFile> protoFiles) {
        System.out.println("Proto Gen Impl here!");

        // Register file to be generated by protoc to 'filer'.
        // If we skip this steps, generated file will not be compiled for some reason
        for (ProtoFile protoFile : protoFiles) {
            if (protoFile.getOuterClassName() == null) {
                continue;
            }
            String fullOuterClassName = protoFile.getPackageName() + "." + protoFile.getOuterClassName();
            JavaFileObject builderFile = filer.createSourceFile(fullOuterClassName);
            PrintWriter out = new PrintWriter(builderFile.openWriter());
            out.close();
        }

        // Get output directory
        FileObject resource = filer.getResource(StandardLocation.SOURCE_OUTPUT, "", "Dummy.java");
        String outputDirectory = Paths.get(resource.toUri()).toFile().getParent();

        // Retrieve the protoc executable
        String executable = isProtocBinaryAvailable() ? "protoc" : outputDirectory.substring(0, outputDirectory.indexOf("target")) + "target/protoc/bin/" + "protoc";

        // Generate using protoc
        String protoPath = protoFiles.get(0).getGeneratedFile().getParent();
        String[] args = new String[]{
                "-I=.",
                "--java_out=" + outputDirectory,
                "--proto_path", protoPath};
        Commandline cl = new Commandline();
        cl.setExecutable(executable);
        cl.addArguments(args);
        protoFiles.forEach(protoFile -> cl.addArguments(new String[]{protoFile.getGeneratedFile().getAbsoluteFile().toString()}));

        int ret = CommandLineUtils.executeCommandLine(cl, null, output, error);
        if (ret != 0) {
            System.err.println("Error generating code using protoc: " + error.getOutput());
        }
    }

    private boolean isProtocBinaryAvailable(){
        String command = "which";
        String executable = "protoc";
        boolean isExecutableAvailable = false;
        try {
            Process process = Runtime.getRuntime().exec(command + " " + executable);
            BufferedReader reader = new BufferedReader(new InputStreamReader(process.getInputStream()));
            String line;
            while ((line = reader.readLine()) != null) {
                if (line.contains(executable)) {
                    isExecutableAvailable = true;
                    break;
                }
            }
            reader.close();
            process.destroy();
        } catch (Exception ignored) {}
        return isExecutableAvailable;
    }
}
